<UserControl
    x:Class="SchedulingApp.Views.RulesView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:hc="https://handyorg.github.io/handycontrol"
    xmlns:local="clr-namespace:SchedulingApp.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="clr-namespace:SchedulingApp.ViewModels"
    d:DataContext="{d:DesignInstance Type=viewmodels:RulesViewModel}"
    d:DesignHeight="800"
    d:DesignWidth="1000"
    mc:Ignorable="d">

    <ScrollViewer>
        <Grid Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!--  Existing general settings and custom holidays  -->
            <Grid Grid.Row="0" Margin="0,0,0,10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <hc:Card
                    Grid.Column="0"
                    Margin="0,0,5,0"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    Header="一般设置">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <TextBlock
                            Grid.Column="0"
                            VerticalAlignment="Center"
                            Text="最大连续工作天数:" />
                        <hc:TextBox
                            Grid.Column="1"
                            Width="100"
                            Height="20"
                            Margin="5,2,0,2"
                            HorizontalAlignment="Left"
                            Text="{Binding Rules.MaxConsecutiveDays, UpdateSourceTrigger=PropertyChanged}" />

                        <TextBlock
                            Grid.Row="1"
                            Grid.Column="0"
                            VerticalAlignment="Center"
                            Text="总休息天数:" />
                        <hc:TextBox
                            Grid.Row="1"
                            Grid.Column="1"
                            Width="100"
                            Height="20"
                            Margin="5,2,0,2"
                            HorizontalAlignment="Left"
                            Text="{Binding Rules.TotalRestDays, UpdateSourceTrigger=PropertyChanged}" />
                    </Grid>
                </hc:Card>

                <hc:Card
                    Grid.Column="1"
                    Margin="5,0,0,0"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    Header="半天班设置">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>


                        <!--  半天班设置部分  -->
                        <TextBlock
                            Grid.Row="0"
                            Margin="0,10,0,5"
                            FontWeight="Bold"
                            Text="半天班设置" />

                        <hc:UniformSpacingPanel
                            Grid.Row="1"
                            Margin="0,0,0,5"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Top"
                            Orientation="Horizontal">
                            <ComboBox
                                Width="120"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Center"
                                DisplayMemberPath="ShiftName"
                                ItemsSource="{Binding AvailableShifts}"
                                SelectedValue="{Binding NewHalfDayShift, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                                SelectedValuePath="ShiftName" />
                            <Button Command="{Binding AddHalfDayShiftCommand}" Content="添加半天班" />
                            <Button Command="{Binding ClearHalfDayShiftsCommand}" Content="清空所有" />
                        </hc:UniformSpacingPanel>

                        <ItemsControl
                            x:Name="HalfDayShiftsItemsControl"
                            Grid.Row="2"
                            ItemsSource="{Binding Rules.HalfDayShifts}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border
                                        Margin="2"
                                        Background="{DynamicResource RegionBrush}"
                                        BorderBrush="{DynamicResource BorderBrush}"
                                        BorderThickness="1"
                                        CornerRadius="4">
                                        <StackPanel Margin="5" Orientation="Horizontal">
                                            <TextBlock VerticalAlignment="Center" Text="{Binding ., UpdateSourceTrigger=PropertyChanged}" />
                                            <Button
                                                Margin="5,0,0,0"
                                                Padding="4"
                                                VerticalAlignment="Center"
                                                Command="{Binding DataContext.RemoveHalfDayShiftCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding .}"
                                                Content="×" />
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Grid>
                </hc:Card>

                <hc:Card
                    Grid.Column="2"
                    Margin="5,0,0,0"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    Header="自定义节假日设置">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>


                        <!--  自定义节假日部分  -->
                        <TextBlock
                            Grid.Row="0"
                            Margin="0,0,0,5"
                            FontWeight="Bold"
                            Text="自定义节假日" />

                        <hc:UniformSpacingPanel
                            Grid.Row="1"
                            Margin="0,0,0,5"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Top"
                            Orientation="Horizontal">
                            <hc:DatePicker
                                Width="120"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Center"
                                SelectedDate="{Binding NewCustomHolidayDate, UpdateSourceTrigger=PropertyChanged}" />
                            <Button Command="{Binding AddCustomHolidayCommand}" Content="添加节假日" />
                            <Button Command="{Binding ClearCustomHolidaysCommand}" Content="清空所有" />
                        </hc:UniformSpacingPanel>

                        <ItemsControl
                            x:Name="CustomHolidaysItemsControl"
                            Grid.Row="2"
                            ItemsSource="{Binding Rules.CustomHolidays}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border
                                        Margin="2"
                                        Background="{DynamicResource RegionBrush}"
                                        BorderBrush="{DynamicResource BorderBrush}"
                                        BorderThickness="1"
                                        CornerRadius="4">
                                        <StackPanel Margin="5" Orientation="Horizontal">
                                            <TextBlock VerticalAlignment="Center" Text="{Binding ., UpdateSourceTrigger=PropertyChanged}" />
                                            <Button
                                                Margin="5,0,0,0"
                                                Padding="4"
                                                VerticalAlignment="Center"
                                                Command="{Binding DataContext.RemoveCustomHolidayCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding .}"
                                                Content="×" />
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Grid>
                </hc:Card>
            </Grid>

            <!--  New section for multiple scheduling rules  -->
            <hc:Card
                Grid.Row="1"
                Margin="0,0,0,10"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                Header="排班规则管理">
                <Grid Margin="10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="170" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <Grid Grid.Column="0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <hc:UniformSpacingPanel
                            Grid.Row="0"
                            HorizontalAlignment="Left"
                            Orientation="Horizontal">
                            <Button
                                Width="80"
                                Command="{Binding AddSchedulingRuleCommand}"
                                Content="添加规则" />
                            <Button
                                Width="80"
                                Command="{Binding RemoveSchedulingRuleCommand}"
                                CommandParameter="{Binding ElementName=RulesDataGrid, Path=SelectedItem}"
                                Content="删除规则" />
                        </hc:UniformSpacingPanel>

                        <DataGrid
                            x:Name="RulesDataGrid"
                            Grid.Row="1"
                            hc:DataGridAttach.ShowRowNumber="True"
                            AutoGenerateColumns="False"
                            BorderBrush="{DynamicResource BorderBrush}"
                            CanUserAddRows="False"
                            CanUserDeleteRows="False"
                            HeadersVisibility="Column"
                            ItemsSource="{Binding SchedulingRules}"
                            SelectedItem="{Binding SelectedRule}">
                            <DataGrid.Columns>
                                <DataGridTextColumn
                                    Width="*"
                                    Binding="{Binding RuleName, UpdateSourceTrigger=PropertyChanged}"
                                    Header="规则名称" />
                            </DataGrid.Columns>
                        </DataGrid>

                    </Grid>

                    <Border
                        Grid.Column="1"
                        Margin="10,0,0,0"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="1">
                        <ScrollViewer>
                            <Grid Margin="10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <!--  Rule Details Header  -->
                                <TextBlock
                                    Grid.Row="0"
                                    Grid.Column="0"
                                    Grid.ColumnSpan="2"
                                    Margin="0,0,0,10"
                                    FontSize="16"
                                    FontWeight="Bold"
                                    Text="{Binding SelectedRule.RuleName, StringFormat='规则详情: {0}'}" />

                                <!--  Workday Shifts Section  -->
                                <hc:Card
                                    Grid.Row="1"
                                    Grid.Column="0"
                                    Margin="0,0,0,10"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    Header="工作日班次需求">
                                    <Grid Margin="10">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="*" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <DataGrid
                                            x:Name="WeekdayShiftsDataGrid"
                                            Grid.Row="0"
                                            Height="120"
                                            hc:DataGridAttach.ShowRowNumber="True"
                                            AutoGenerateColumns="False"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            CanUserAddRows="False"
                                            CanUserDeleteRows="True"
                                            HeadersVisibility="Column"
                                            ItemsSource="{Binding SelectedRule.WeekdayShifts}">
                                            <DataGrid.Columns>
                                                <DataGridTemplateColumn Width="150" Header="班次名称">
                                                    <DataGridTemplateColumn.CellTemplate>
                                                        <DataTemplate>
                                                            <ComboBox
                                                                HorizontalAlignment="Stretch"
                                                                VerticalAlignment="Center"
                                                                DisplayMemberPath="ShiftName"
                                                                ItemsSource="{Binding DataContext.AvailableShifts, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                SelectedValue="{Binding ShiftName, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                                                                SelectedValuePath="ShiftName" />
                                                        </DataTemplate>
                                                    </DataGridTemplateColumn.CellTemplate>
                                                    <DataGridTemplateColumn.CellEditingTemplate>
                                                        <DataTemplate>
                                                            <ComboBox
                                                                HorizontalAlignment="Stretch"
                                                                VerticalAlignment="Center"
                                                                DisplayMemberPath="ShiftName"
                                                                IsEditable="False"
                                                                ItemsSource="{Binding DataContext.AvailableShifts, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                SelectedValue="{Binding ShiftName, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                                                                SelectedValuePath="ShiftName" />
                                                        </DataTemplate>
                                                    </DataGridTemplateColumn.CellEditingTemplate>
                                                </DataGridTemplateColumn>
                                                <DataGridTextColumn
                                                    Width="150"
                                                    Binding="{Binding RequiredCount, UpdateSourceTrigger=PropertyChanged}"
                                                    Header="需求数量" />
                                                <DataGridTextColumn
                                                    Width="80"
                                                    Binding="{Binding Priority, UpdateSourceTrigger=PropertyChanged}"
                                                    Header="优先级" />
                                            </DataGrid.Columns>
                                        </DataGrid>

                                        <hc:UniformSpacingPanel
                                            Grid.Row="1"
                                            HorizontalAlignment="Left"
                                            Orientation="Horizontal">
                                            <Button
                                                Width="100"
                                                Command="{Binding AddWeekdayShiftToRuleCommand}"
                                                Content="添加班次" />
                                            <Button
                                                Width="100"
                                                Command="{Binding RemoveWeekdayShiftFromRuleCommand}"
                                                CommandParameter="{Binding ElementName=WeekdayShiftsDataGrid, Path=SelectedItem}"
                                                Content="删除选中" />
                                        </hc:UniformSpacingPanel>
                                    </Grid>
                                </hc:Card>

                                <!--  Holiday Shifts Section  -->
                                <hc:Card
                                    Grid.Row="2"
                                    Grid.Column="0"
                                    Margin="0,0,0,10"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    Header="节假日班次需求">
                                    <Grid Margin="10">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="*" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <DataGrid
                                            x:Name="HolidayShiftsDataGrid"
                                            Grid.Row="0"
                                            Height="120"
                                            hc:DataGridAttach.ShowRowNumber="True"
                                            AutoGenerateColumns="False"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            CanUserAddRows="False"
                                            CanUserDeleteRows="True"
                                            HeadersVisibility="Column"
                                            ItemsSource="{Binding SelectedRule.HolidayShifts}">
                                            <DataGrid.Columns>
                                                <DataGridTemplateColumn Width="150" Header="班次名称">
                                                    <DataGridTemplateColumn.CellTemplate>
                                                        <DataTemplate>
                                                            <ComboBox
                                                                HorizontalAlignment="Stretch"
                                                                VerticalAlignment="Center"
                                                                DisplayMemberPath="ShiftName"
                                                                ItemsSource="{Binding DataContext.AvailableShifts, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                SelectedValue="{Binding ShiftName, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                                                                SelectedValuePath="ShiftName" />
                                                        </DataTemplate>
                                                    </DataGridTemplateColumn.CellTemplate>
                                                    <DataGridTemplateColumn.CellEditingTemplate>
                                                        <DataTemplate>
                                                            <ComboBox
                                                                HorizontalAlignment="Stretch"
                                                                VerticalAlignment="Center"
                                                                DisplayMemberPath="ShiftName"
                                                                IsEditable="False"
                                                                ItemsSource="{Binding DataContext.AvailableShifts, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                SelectedValue="{Binding ShiftName, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                                                                SelectedValuePath="ShiftName" />
                                                        </DataTemplate>
                                                    </DataGridTemplateColumn.CellEditingTemplate>
                                                </DataGridTemplateColumn>
                                                <DataGridTextColumn
                                                    Width="150"
                                                    Binding="{Binding RequiredCount, UpdateSourceTrigger=PropertyChanged}"
                                                    Header="需求数量" />
                                                <DataGridTextColumn
                                                    Width="80"
                                                    Binding="{Binding Priority, UpdateSourceTrigger=PropertyChanged}"
                                                    Header="优先级" />
                                            </DataGrid.Columns>
                                        </DataGrid>

                                        <hc:UniformSpacingPanel
                                            Grid.Row="1"
                                            HorizontalAlignment="Left"
                                            Orientation="Horizontal">
                                            <Button
                                                Width="100"
                                                Command="{Binding AddHolidayShiftToRuleCommand}"
                                                Content="添加班次" />
                                            <Button
                                                Width="100"
                                                Command="{Binding RemoveHolidayShiftFromRuleCommand}"
                                                CommandParameter="{Binding ElementName=HolidayShiftsDataGrid, Path=SelectedItem}"
                                                Content="删除选中" />
                                        </hc:UniformSpacingPanel>
                                    </Grid>
                                </hc:Card>

                                <!--  Applicable Staff Section  -->
                                <hc:Card
                                    Grid.Row="1"
                                    Grid.RowSpan="2"
                                    Grid.Column="1"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    Header="适用员工">
                                    <Grid Margin="10">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="*" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <Grid Grid.Row="0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="40" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>

                                            <hc:Card
                                                Grid.Column="0"
                                                Margin="0,0,5,0"
                                                Header="可用员工">
                                                <DataGrid
                                                    x:Name="AvailableStaffDataGrid"
                                                    Height="330"
                                                    hc:DataGridAttach.ShowRowNumber="True"
                                                    AutoGenerateColumns="False"
                                                    BorderBrush="{DynamicResource BorderBrush}"
                                                    CanUserAddRows="False"
                                                    CanUserDeleteRows="False"
                                                    HeadersVisibility="Column"
                                                    ItemsSource="{Binding AvailableStaff}">
                                                    <DataGrid.Columns>
                                                        <DataGridTextColumn
                                                            Width="*"
                                                            Binding="{Binding Name}"
                                                            Header="员工姓名" />
                                                        <DataGridTextColumn
                                                            Width="*"
                                                            Binding="{Binding Group}"
                                                            Header="组别" />
                                                    </DataGrid.Columns>
                                                </DataGrid>
                                            </hc:Card>

                                            <StackPanel
                                                Grid.Column="1"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center">
                                                <Button
                                                    Height="30"
                                                    Margin="0,2"
                                                    Command="{Binding AddStaffToRuleCommand}"
                                                    CommandParameter="{Binding ElementName=AvailableStaffDataGrid, Path=SelectedItems}"
                                                    Content="→" />
                                                <Button
                                                    Height="30"
                                                    Margin="0,2"
                                                    Command="{Binding RemoveStaffFromRuleCommand}"
                                                    CommandParameter="{Binding ElementName=SelectedStaffDataGrid, Path=SelectedItem}"
                                                    Content="←" />
                                            </StackPanel>

                                            <hc:Card
                                                Grid.Column="2"
                                                Margin="5,0,0,0"
                                                Header="已选员工">
                                                <DataGrid
                                                    x:Name="SelectedStaffDataGrid"
                                                    Height="330"
                                                    hc:DataGridAttach.ShowRowNumber="True"
                                                    AutoGenerateColumns="False"
                                                    BorderBrush="{DynamicResource BorderBrush}"
                                                    CanUserAddRows="False"
                                                    CanUserDeleteRows="False"
                                                    HeadersVisibility="Column"
                                                    ItemsSource="{Binding SelectedRule.ApplicableStaff}">
                                                    <DataGrid.Columns>
                                                        <DataGridTextColumn
                                                            Width="*"
                                                            Binding="{Binding .}"
                                                            Header="员工姓名" />
                                                    </DataGrid.Columns>
                                                </DataGrid>
                                            </hc:Card>
                                        </Grid>
                                    </Grid>
                                </hc:Card>
                            </Grid>
                        </ScrollViewer>
                    </Border>
                </Grid>
            </hc:Card>

            <!--  Existing save/load buttons  -->
            <hc:UniformSpacingPanel
                Grid.Row="2"
                HorizontalAlignment="Right"
                Orientation="Horizontal">
                <Button Command="{Binding SaveRulesCommand}" Content="保存规则" />
                <Button Command="{Binding LoadRulesCommand}" Content="加载规则" />
            </hc:UniformSpacingPanel>
        </Grid>
    </ScrollViewer>
</UserControl>